# Iteration Log - Stage 4: Testing (UnpackTesting)
## Timestamp: 2026-02-14T03:53:22.056Z

## Summary
Completed Stage 4 (Testing). All 176 Playwright tests now pass (from 80 pass / 96 fail initial state).

## Key Changes

### Backend Fixes
1. **netlify/functions/clients.ts** - Added timeline event creation for client status changes (INSERT INTO timeline_events when status changes via PUT)
2. **netlify/functions/clients.ts** - Fixed WHERE clause to use `::uuid` cast for resourceId in PUT handler

### Test Fixes (Timing / Async Patterns)
All test failures were caused by assertions running before filtered/sorted data rendered after React state updates. The pattern used to fix all of them:
- Replaced `await page.waitForLoadState('networkidle')` + immediate assertions with `await expect(async () => { ... }).toPass({ timeout: 10000 })` retry patterns

Specific fixes:
3. **tests/clients-list-page.spec.ts** - Fixed 6 tests (CLP-SRCH-02, CLP-FLT-02, CLP-FLT-06, CLP-FLT-08, CLP-FLT-09, CLP-TBL-08) with toPass() patterns for filter/search/sort results
4. **tests/deals-list-page.spec.ts** - Fixed 2 tests (DLP-FLT-02, DLP-FLT-04) with toPass() patterns for stage and client filter results
5. **tests/tasks-list-page.spec.ts** - Fixed 2 tests (TLP-FLT-02, TLP-FLT-04) with toPass() patterns for priority and assignee filter results
6. **tests/deal-detail-page.spec.ts** - Fixed 3 tests:
   - DDP-HDR-04: Added proper waits for stage change to propagate, verify button disabled state after change
   - DDP-HIS-02: Added toPass() to wait for history entry count to increase
   - DDP-ATT-05: Added wait for attachment to appear before deleting, used Playwright auto-retry for removal assertion
7. **tests/cross-cutting.spec.ts** - Fixed 3 tests:
   - DATA-02: Fixed task toggle to target specific task by name rather than first/last; added toPass() for search verification
   - DATA-03: Used `.first()` for `getByText(personName)` to handle multiple matches on PersonDetailPage
   - ATOM-02: Added robust waiting for deal stage select, Change Stage button enabled state, and timeline entry loading
   - ATOM-03: Added toPass() for timeline entry count assertion after page reload

## Test Results
- **Before**: 80 passed, 96 failed (in previous iterations)
- **After fix 1 (backend SQL)**: 160 passed, 16 failed
- **After fix 2 (test timing)**: 176 passed, 0 failed

## Files Modified
- netlify/functions/clients.ts
- tests/clients-list-page.spec.ts
- tests/deals-list-page.spec.ts
- tests/tasks-list-page.spec.ts
- tests/deal-detail-page.spec.ts
- tests/cross-cutting.spec.ts
